generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Int      @default(1)
  isAdmin   Boolean  @default(false)

  @@map("users")
}

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  products    Product[]
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

  @@map("categories")
}

model Product {
  id          String    @id @default(cuid())
  name        String
  description String?
  image       String?
  stock       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  brand       String?
  categoryId  String?
  images      String?   @db.LongText
  specs       String?   @db.LongText
  slug        String?   @unique
  offers      Offer[]
  category    Category? @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([isActive, createdAt])
  @@index([slug])
  @@map("products")
}

model Merchant {
  id      String  @id @default(cuid())
  name    String
  domain  String  @unique
  network String
  logo    String?
  slug    String? @unique
  offers  Offer[]

  @@map("merchants")
}

model Offer {
  id           String         @id @default(cuid())
  productId    String
  merchantId   String
  url          String
  affiliateUrl String
  inStock      Boolean        @default(true)
  currentPrice Decimal?       @db.Decimal(12, 2)
  stockStatus  StockStatus    @default(IN_STOCK)
  clicks       Click[]
  merchant     Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  product      Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  prices       PriceHistory[]

  @@unique([productId, merchantId])
  @@index([productId, merchantId])
  @@index([merchantId])
  @@index([productId])
  @@map("offers")
}

model PriceHistory {
  id         String   @id @default(cuid())
  offerId    String
  price      Decimal  @db.Decimal(12, 2)
  capturedAt DateTime @default(now())
  offer      Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId, capturedAt])
  @@map("price_history")
}

model Click {
  id         String   @id @default(cuid())
  offerId    String
  subid      String
  ipHash     String   @db.Char(64)
  ua         String?  @db.VarChar(512)
  referer    String?  @db.VarChar(512)
  clickedAt  DateTime @default(now())
  merchantId String?
  productId  String?
  offer      Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId, clickedAt])
  @@index([subid])
  @@index([productId, clickedAt])
  @@index([merchantId, clickedAt])
  @@map("clicks")
}

enum StockStatus {
  IN_STOCK
  OUT_OF_STOCK
}
