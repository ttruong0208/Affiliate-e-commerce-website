// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
  // Khai báo output để tránh cảnh báo khi lên Prisma 7
  output        = "./node_modules/@prisma/client"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  // Nếu dùng PlanetScale, bật dòng dưới:
  // relationMode = "prisma"
}

/**
 * =========================
 * Users / Auth (đơn giản)
 * =========================
 */
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cartItems CartItem[]
  orders    Order[]

  @@map("users")
}

/**
 * =========================
 * Catalog (Sản phẩm)
 * =========================
 */
model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2) // tiền: dùng Decimal
  image       String?
  category    String?
  stock       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  cartItems  CartItem[]
  orderItems OrderItem[]
  offers     Offer[] // Affiliate offers

  @@index([category])
  @@map("products")
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userId, productId])
  @@map("cart_items")
}

/**
 * =========================
 * Orders
 * =========================
 */
model Order {
  id              String      @id @default(cuid())
  userId          String
  orderNumber     String      @unique
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(12, 2)
  customerName    String
  customerEmail   String
  customerPhone   String?
  shippingAddress String
  paymentIntentId String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  orderItems OrderItem[]

  @@index([userId, status])
  @@map("orders")
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(12, 2)

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([orderId])
  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

/**
 * =========================
 * Affiliate (Merchant/Offer/Click/Price)
 * =========================
 */
model Merchant {
  id      String  @id @default(cuid())
  name    String
  domain  String  @unique
  network String // accesstrade | masoffer | adflex | custom
  offers  Offer[]

  @@map("merchants")
}

model Offer {
  id           String  @id @default(cuid())
  productId    String
  merchantId   String
  url          String // link gốc sản phẩm
  affiliateUrl String // deeplink từ mạng affiliate
  inStock      Boolean @default(true)

  product  Product        @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  merchant Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  prices   PriceHistory[]
  clicks   Click[]

  @@index([productId, merchantId])
  @@map("offers")
}

model PriceHistory {
  id         String   @id @default(cuid())
  offerId    String
  price      Decimal  @db.Decimal(12, 2)
  capturedAt DateTime @default(now())

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([offerId, capturedAt])
  @@map("price_history")
}

model Click {
  id        String   @id @default(cuid())
  offerId   String
  subid     String   @unique // để đối soát conversion từ network
  ipHash    String // không lưu IP thô
  ua        String?
  referer   String?
  clickedAt DateTime @default(now())

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([offerId, clickedAt])
  @@map("clicks")
}
